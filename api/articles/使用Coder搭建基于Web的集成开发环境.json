{"title":"使用Coder搭建基于Web的集成开发环境","slug":"使用Coder搭建基于Web的集成开发环境","date":"2025-01-11T02:00:00.000Z","updated":"2025-01-11T02:00:00.000Z","comments":true,"path":"api/articles/使用Coder搭建基于Web的集成开发环境.json","excerpt":"前言Coder 是一个开源的云端开发环境平台，它允许开发团队在 Kubernetes 集群中创建和管理基于 Web 的集成开发环境。与传统的本地开发环境相比，Coder 提供了更好的资源管理、安全性和团队协作能力。本文将详细介绍如何在 Kubernetes 集群中部署 Coder，并配置一个完整的 Web IDE 环境。","covers":null,"content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Coder 是一个开源的云端开发环境平台，它允许开发团队在 Kubernetes 集群中创建和管理基于 Web 的集成开发环境。与传统的本地开发环境相比，Coder 提供了更好的资源管理、安全性和团队协作能力。</p>\n<p>本文将详细介绍如何在 Kubernetes 集群中部署 Coder，并配置一个完整的 Web IDE 环境。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"Coder-简介\"><a href=\"#Coder-简介\" class=\"headerlink\" title=\"Coder 简介\"></a>Coder 简介</h2><h3 id=\"什么是-Coder\"><a href=\"#什么是-Coder\" class=\"headerlink\" title=\"什么是 Coder\"></a>什么是 Coder</h3><p>Coder 是一个现代化的远程开发平台，具有以下特点：</p>\n<ul>\n<li><strong>云原生架构</strong>：基于 Kubernetes 容器编排</li>\n<li><strong>Web 访问</strong>：通过浏览器即可访问完整的开发环境</li>\n<li><strong>模板化管理</strong>：支持预定义的开发环境模板</li>\n<li><strong>多租户支持</strong>：支持多用户、多团队使用</li>\n<li><strong>安全隔离</strong>：每个开发环境独立运行，保证安全性</li>\n</ul>\n<h3 id=\"核心优势\"><a href=\"#核心优势\" class=\"headerlink\" title=\"核心优势\"></a>核心优势</h3><ol>\n<li><strong>统一开发环境</strong>：消除”在我机器上可以运行”的问题</li>\n<li><strong>快速上手</strong>：新员工可以快速获得标准化的开发环境</li>\n<li><strong>资源优化</strong>：按需分配计算资源，提高利用率</li>\n<li><strong>安全管控</strong>：代码和敏感数据不离开集群环境</li>\n<li><strong>跨平台访问</strong>：任何设备都可以通过浏览器访问开发环境</li>\n</ol>\n<h2 id=\"环境要求\"><a href=\"#环境要求\" class=\"headerlink\" title=\"环境要求\"></a>环境要求</h2><h3 id=\"基础要求\"><a href=\"#基础要求\" class=\"headerlink\" title=\"基础要求\"></a>基础要求</h3><ul>\n<li>Kubernetes 集群 (K8s 1.19+)</li>\n<li>Helm 3.5+ </li>\n<li>PostgreSQL 数据库</li>\n<li>负载均衡器支持</li>\n<li>TLS 证书（生产环境推荐）</li>\n</ul>\n<h3 id=\"资源规划\"><a href=\"#资源规划\" class=\"headerlink\" title=\"资源规划\"></a>资源规划</h3><ul>\n<li><strong>控制平面</strong>：2 CPU / 4GB RAM（最小配置）</li>\n<li><strong>数据库</strong>：2 CPU / 4GB RAM / 10GB 存储</li>\n<li><strong>工作空间</strong>：根据实际开发需求配置</li>\n</ul>\n<h2 id=\"安装部署步骤\"><a href=\"#安装部署步骤\" class=\"headerlink\" title=\"安装部署步骤\"></a>安装部署步骤</h2><h3 id=\"1-创建命名空间\"><a href=\"#1-创建命名空间\" class=\"headerlink\" title=\"1. 创建命名空间\"></a>1. 创建命名空间</h3><p>首先创建专用的命名空间来部署 Coder 相关组件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create namespace coder</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-部署-PostgreSQL-数据库\"><a href=\"#2-部署-PostgreSQL-数据库\" class=\"headerlink\" title=\"2. 部署 PostgreSQL 数据库\"></a>2. 部署 PostgreSQL 数据库</h3><p>Coder 需要 PostgreSQL 数据库来存储配置和状态信息。使用 Bitnami PostgreSQL Helm Chart：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加 Bitnami Helm 仓库</span></span><br><span class=\"line\">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 PostgreSQL</span></span><br><span class=\"line\">helm install coder-db ./postgresql \\</span><br><span class=\"line\">    --namespace coder \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> auth.username=coder \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> auth.password=coder \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> auth.database=coder \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> persistence.size=10Gi</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>注意</strong>：生产环境建议使用云服务商提供的托管 PostgreSQL 服务，如 AWS RDS、Google Cloud SQL 等。</p>\n</blockquote>\n<h3 id=\"3-创建数据库连接密钥\"><a href=\"#3-创建数据库连接密钥\" class=\"headerlink\" title=\"3. 创建数据库连接密钥\"></a>3. 创建数据库连接密钥</h3><p>创建包含数据库连接字符串的 Secret：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create secret generic coder-db-url -n coder \\</span><br><span class=\"line\">  --from-literal=url=<span class=\"string\">&quot;postgres://coder:coder@coder-db-postgresql.coder.svc.cluster.local:5432/coder?sslmode=disable&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>连接字符串格式说明：</p>\n<ul>\n<li><code>coder:coder</code> - 用户名和密码</li>\n<li><code>coder-db-postgresql.coder.svc.cluster.local</code> - 服务内部 DNS 名称</li>\n<li><code>5432</code> - PostgreSQL 默认端口</li>\n<li><code>coder</code> - 数据库名称</li>\n</ul>\n<h3 id=\"4-配置-OAuth-认证（可选）\"><a href=\"#4-配置-OAuth-认证（可选）\" class=\"headerlink\" title=\"4. 配置 OAuth 认证（可选）\"></a>4. 配置 OAuth 认证（可选）</h3><p>如果使用 GitLab OAuth 认证，创建相应的密钥：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create secret generic coder-gitlab-oauth-secret -n coder \\</span><br><span class=\"line\">  --from-literal=client-secret=<span class=\"string\">&quot;your-gitlab-oauth-client-secret&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-配置-TLS-证书\"><a href=\"#5-配置-TLS-证书\" class=\"headerlink\" title=\"5. 配置 TLS 证书\"></a>5. 配置 TLS 证书</h3><p>为 HTTPS 访问创建 TLS 证书密钥：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create secret tls coder-tls-secret -n coder \\</span><br><span class=\"line\">  --key=<span class=\"string\">&quot;_wildcard.coder.vxk8s.com+1-key.pem&quot;</span> \\</span><br><span class=\"line\">  --cert=<span class=\"string\">&quot;_wildcard.coder.vxk8s.com+1.pem&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>如果需要更新证书：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create secret tls coder-tls-secret -n coder \\</span><br><span class=\"line\">  --key=<span class=\"string\">&quot;_wildcard.coder.vxk8s.com+1-key.pem&quot;</span> \\</span><br><span class=\"line\">  --cert=<span class=\"string\">&quot;_wildcard.coder.vxk8s.com+1.pem&quot;</span> \\</span><br><span class=\"line\">  --dry-run=client -o yaml | kubectl apply -f -</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6-配置-CA-证书包（如需要）\"><a href=\"#6-配置-CA-证书包（如需要）\" class=\"headerlink\" title=\"6. 配置 CA 证书包（如需要）\"></a>6. 配置 CA 证书包（如需要）</h3><p>如果使用自签名证书或企业 CA，创建 CA 证书包：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create secret generic coder-ca-bundle -n coder \\</span><br><span class=\"line\">  --from-literal=ca-certs=<span class=\"string\">&quot;-----BEGIN CERTIFICATE-----</span></span><br><span class=\"line\"><span class=\"string\">MIIExjCCAy6gAwIBAgIRAPiKt6qzOqWHWGxkzg06YIYwDQYJKoZIhvcNAQELBQAw</span></span><br><span class=\"line\"><span class=\"string\"># ... 证书内容 ...</span></span><br><span class=\"line\"><span class=\"string\">-----END CERTIFICATE-----&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"7-准备-Helm-Values-文件\"><a href=\"#7-准备-Helm-Values-文件\" class=\"headerlink\" title=\"7. 准备 Helm Values 文件\"></a>7. 准备 Helm Values 文件</h3><p>创建 <code>values.yaml</code> 配置文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">coder:</span></span><br><span class=\"line\">  <span class=\"attr\">env:</span></span><br><span class=\"line\">    <span class=\"comment\"># 数据库连接配置</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_PG_CONNECTION_URL</span></span><br><span class=\"line\">      <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">        <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">coder-db-url</span></span><br><span class=\"line\">          <span class=\"attr\">key:</span> <span class=\"string\">url</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># 访问地址配置</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_ACCESS_URL</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">&quot;https://coder.vxk8s.com&quot;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># 禁用默认 GitHub OAuth（使用自定义认证）</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_OAUTH2_GITHUB_DEFAULT_PROVIDER_ENABLE</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># GitLab OAuth 配置（可选）</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_OAUTH2_GITLAB_CLIENT_ID</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">&quot;your-gitlab-client-id&quot;</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_OAUTH2_GITLAB_CLIENT_SECRET</span></span><br><span class=\"line\">      <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">        <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">coder-gitlab-oauth-secret</span></span><br><span class=\"line\">          <span class=\"attr\">key:</span> <span class=\"string\">client-secret</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_OAUTH2_GITLAB_REDIRECT_URL</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">&quot;https://coder.vxk8s.com/api/v2/users/oauth2/gitlab/callback&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># TLS 配置</span></span><br><span class=\"line\">  <span class=\"attr\">tls:</span></span><br><span class=\"line\">    <span class=\"attr\">secretNames:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">coder-tls-secret</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 服务配置</span></span><br><span class=\"line\">  <span class=\"attr\">service:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">LoadBalancer</span></span><br><span class=\"line\">    <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">    <span class=\"attr\">annotations:</span></span><br><span class=\"line\">      <span class=\"attr\">service.beta.kubernetes.io/aws-load-balancer-type:</span> <span class=\"string\">&quot;nlb&quot;</span>  <span class=\"comment\"># AWS 环境</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 资源限制</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">cpu:</span> <span class=\"string\">&quot;500m&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">memory:</span> <span class=\"string\">&quot;1Gi&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">limits:</span></span><br><span class=\"line\">      <span class=\"attr\">cpu:</span> <span class=\"string\">&quot;2000m&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">memory:</span> <span class=\"string\">&quot;4Gi&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"8-安装-Coder\"><a href=\"#8-安装-Coder\" class=\"headerlink\" title=\"8. 安装 Coder\"></a>8. 安装 Coder</h3><p>添加 Coder Helm 仓库并安装：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加 Coder Helm 仓库</span></span><br><span class=\"line\">helm repo add coder-v2 https://helm.coder.com/v2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 Coder</span></span><br><span class=\"line\">helm install coder coder-v2/coder \\</span><br><span class=\"line\">    --namespace coder \\</span><br><span class=\"line\">    --values values.yaml \\</span><br><span class=\"line\">    --version 2.22.1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"9-验证部署状态\"><a href=\"#9-验证部署状态\" class=\"headerlink\" title=\"9. 验证部署状态\"></a>9. 验证部署状态</h3><p>检查 Pod 运行状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pods -n coder</span><br></pre></td></tr></table></figure>\n\n<p>获取服务访问地址：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get svc -n coder</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"10-升级和维护\"><a href=\"#10-升级和维护\" class=\"headerlink\" title=\"10. 升级和维护\"></a>10. 升级和维护</h3><p>更新 Coder 版本：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm upgrade coder coder-v2/coder \\</span><br><span class=\"line\">    --namespace coder \\</span><br><span class=\"line\">    --values values.yaml \\</span><br><span class=\"line\">    --version 2.22.1</span><br></pre></td></tr></table></figure>\n\n<p>强制重启 Pod（如果需要）：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl delete pod &lt;pod-name&gt; -n coder --grace-period=0 --force</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置管理\"><a href=\"#配置管理\" class=\"headerlink\" title=\"配置管理\"></a>配置管理</h2><h3 id=\"环境变量配置\"><a href=\"#环境变量配置\" class=\"headerlink\" title=\"环境变量配置\"></a>环境变量配置</h3><p>Coder 支持通过环境变量进行详细配置，常用配置项：</p>\n<table>\n<thead>\n<tr>\n<th>环境变量</th>\n<th>说明</th>\n<th>示例值</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>CODER_ACCESS_URL</code></td>\n<td>外部访问地址</td>\n<td><code>https://coder.example.com</code></td>\n</tr>\n<tr>\n<td><code>CODER_PG_CONNECTION_URL</code></td>\n<td>数据库连接字符串</td>\n<td><code>postgres://user:pass@host:5432/db</code></td>\n</tr>\n<tr>\n<td><code>CODER_OAUTH2_GITHUB_CLIENT_ID</code></td>\n<td>GitHub OAuth 客户端 ID</td>\n<td><code>your-client-id</code></td>\n</tr>\n<tr>\n<td><code>CODER_PROMETHEUS_ENABLE</code></td>\n<td>启用 Prometheus 监控</td>\n<td><code>true</code></td>\n</tr>\n<tr>\n<td><code>CODER_PPROF_ENABLE</code></td>\n<td>启用性能分析</td>\n<td><code>true</code></td>\n</tr>\n</tbody></table>\n<h3 id=\"负载均衡器配置\"><a href=\"#负载均衡器配置\" class=\"headerlink\" title=\"负载均衡器配置\"></a>负载均衡器配置</h3><h4 id=\"AWS-环境\"><a href=\"#AWS-环境\" class=\"headerlink\" title=\"AWS 环境\"></a>AWS 环境</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">coder:</span></span><br><span class=\"line\">  <span class=\"attr\">service:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">LoadBalancer</span></span><br><span class=\"line\">    <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">    <span class=\"attr\">externalTrafficPolicy:</span> <span class=\"string\">Local</span></span><br><span class=\"line\">    <span class=\"attr\">annotations:</span></span><br><span class=\"line\">      <span class=\"attr\">service.beta.kubernetes.io/aws-load-balancer-type:</span> <span class=\"string\">&quot;nlb&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Azure-环境\"><a href=\"#Azure-环境\" class=\"headerlink\" title=\"Azure 环境\"></a>Azure 环境</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">coder:</span></span><br><span class=\"line\">  <span class=\"attr\">service:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">LoadBalancer</span></span><br><span class=\"line\">    <span class=\"attr\">annotations:</span></span><br><span class=\"line\">      <span class=\"attr\">service.beta.kubernetes.io/azure-load-balancer-internal:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安全配置\"><a href=\"#安全配置\" class=\"headerlink\" title=\"安全配置\"></a>安全配置</h3><h4 id=\"网络策略\"><a href=\"#网络策略\" class=\"headerlink\" title=\"网络策略\"></a>网络策略</h4><p>创建网络策略限制访问：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">coder-network-policy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">coder</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">coder</span></span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br><span class=\"line\">  <span class=\"attr\">ingress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">from:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">namespaceSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"RBAC-配置\"><a href=\"#RBAC-配置\" class=\"headerlink\" title=\"RBAC 配置\"></a>RBAC 配置</h4><p>Coder 需要适当的 RBAC 权限来管理工作空间：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">coder</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">coder</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">coder</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;pods&quot;</span>, <span class=\"string\">&quot;services&quot;</span>, <span class=\"string\">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>, <span class=\"string\">&quot;delete&quot;</span>]</span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;apps&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;deployments&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>, <span class=\"string\">&quot;delete&quot;</span>]</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"工作空间模板\"><a href=\"#工作空间模板\" class=\"headerlink\" title=\"工作空间模板\"></a>工作空间模板</h2><h3 id=\"创建基础模板\"><a href=\"#创建基础模板\" class=\"headerlink\" title=\"创建基础模板\"></a>创建基础模板</h3><p>Coder 使用 Terraform 来定义工作空间模板。以下是一个基础的 Python 开发环境模板：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">terraform &#123;</span><br><span class=\"line\">  required_providers &#123;</span><br><span class=\"line\">    coder = &#123;</span><br><span class=\"line\">      source  = &quot;coder/coder&quot;</span><br><span class=\"line\">      version = &quot;~&gt; 0.12.0&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    kubernetes = &#123;</span><br><span class=\"line\">      source  = &quot;hashicorp/kubernetes&quot;</span><br><span class=\"line\">      version = &quot;~&gt; 2.18&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">variable &quot;use_kubeconfig&quot; &#123;</span><br><span class=\"line\">  type        = bool</span><br><span class=\"line\">  sensitive   = true</span><br><span class=\"line\">  description = &lt;&lt;-EOF</span><br><span class=\"line\">  Use host kubeconfig? (true/false)</span><br><span class=\"line\">  Set this to false if the Coder host is itself running as a Pod on the same</span><br><span class=\"line\">  Kubernetes cluster as you are deploying workspaces to.</span><br><span class=\"line\">  Set this to true if the Coder host is running outside the Kubernetes cluster</span><br><span class=\"line\">  (e.g. on a VM or your local machine).</span><br><span class=\"line\">  EOF</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">data &quot;coder_provisioner&quot; &quot;me&quot; &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">provider &quot;kubernetes&quot; &#123;</span><br><span class=\"line\">  # Authenticate via ~/.kube/config or a Coder-specific ServiceAccount, depending on admin preferences</span><br><span class=\"line\">  config_path = var.use_kubeconfig == true ? &quot;~/.kube/config&quot; : null</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">data &quot;coder_workspace&quot; &quot;me&quot; &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">resource &quot;coder_agent&quot; &quot;main&quot; &#123;</span><br><span class=\"line\">  arch                   = data.coder_provisioner.me.arch</span><br><span class=\"line\">  os                     = &quot;linux&quot;</span><br><span class=\"line\">  startup_script_timeout = 180</span><br><span class=\"line\">  startup_script         = &lt;&lt;-EOT</span><br><span class=\"line\">    set -e</span><br><span class=\"line\">    # 安装基础工具</span><br><span class=\"line\">    sudo apt-get update</span><br><span class=\"line\">    sudo apt-get install -y curl wget git vim</span><br><span class=\"line\">    </span><br><span class=\"line\">    # 安装 Python 和相关工具</span><br><span class=\"line\">    sudo apt-get install -y python3 python3-pip python3-venv</span><br><span class=\"line\">    </span><br><span class=\"line\">    # 安装 VS Code Server</span><br><span class=\"line\">    curl -fsSL https://code-server.dev/install.sh | sh</span><br><span class=\"line\">    code-server --bind-addr 0.0.0.0:8080 --auth none &amp;</span><br><span class=\"line\">  EOT</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">resource &quot;kubernetes_deployment&quot; &quot;main&quot; &#123;</span><br><span class=\"line\">  count = data.coder_workspace.me.start_count</span><br><span class=\"line\">  metadata &#123;</span><br><span class=\"line\">    name      = &quot;coder-$&#123;data.coder_workspace.me.owner&#125;-$&#123;data.coder_workspace.me.name&#125;&quot;</span><br><span class=\"line\">    namespace = &quot;coder&quot;</span><br><span class=\"line\">    labels = &#123;</span><br><span class=\"line\">      &quot;app.kubernetes.io/name&quot;     = &quot;coder-workspace&quot;</span><br><span class=\"line\">      &quot;app.kubernetes.io/instance&quot; = &quot;coder-workspace-$&#123;data.coder_workspace.me.owner&#125;-$&#123;data.coder_workspace.me.name&#125;&quot;</span><br><span class=\"line\">      &quot;app.kubernetes.io/part-of&quot;  = &quot;coder&quot;</span><br><span class=\"line\">      &quot;com.coder.resource&quot;         = &quot;true&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  spec &#123;</span><br><span class=\"line\">    replicas = 1</span><br><span class=\"line\">    selector &#123;</span><br><span class=\"line\">      match_labels = &#123;</span><br><span class=\"line\">        &quot;app.kubernetes.io/name&quot; = &quot;coder-workspace&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    template &#123;</span><br><span class=\"line\">      metadata &#123;</span><br><span class=\"line\">        labels = &#123;</span><br><span class=\"line\">          &quot;app.kubernetes.io/name&quot; = &quot;coder-workspace&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      spec &#123;</span><br><span class=\"line\">        security_context &#123;</span><br><span class=\"line\">          run_as_user = &quot;1000&quot;</span><br><span class=\"line\">          fs_group    = &quot;1000&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        container &#123;</span><br><span class=\"line\">          name              = &quot;dev&quot;</span><br><span class=\"line\">          image             = &quot;codercom/enterprise-base:ubuntu&quot;</span><br><span class=\"line\">          image_pull_policy = &quot;Always&quot;</span><br><span class=\"line\">          command           = [&quot;sh&quot;, &quot;-c&quot;, coder_agent.main.init_script]</span><br><span class=\"line\">          security_context &#123;</span><br><span class=\"line\">            run_as_user = &quot;1000&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          env &#123;</span><br><span class=\"line\">            name  = &quot;CODER_AGENT_TOKEN&quot;</span><br><span class=\"line\">            value = coder_agent.main.token</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          resources &#123;</span><br><span class=\"line\">            requests = &#123;</span><br><span class=\"line\">              &quot;cpu&quot;    = &quot;500m&quot;</span><br><span class=\"line\">              &quot;memory&quot; = &quot;1Gi&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            limits = &#123;</span><br><span class=\"line\">              &quot;cpu&quot;    = &quot;2000m&quot;</span><br><span class=\"line\">              &quot;memory&quot; = &quot;4Gi&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          volume_mount &#123;</span><br><span class=\"line\">            mount_path = &quot;/home/coder&quot;</span><br><span class=\"line\">            name       = &quot;home&quot;</span><br><span class=\"line\">            read_only  = false</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        volume &#123;</span><br><span class=\"line\">          name = &quot;home&quot;</span><br><span class=\"line\">          persistent_volume_claim &#123;</span><br><span class=\"line\">            claim_name = kubernetes_persistent_volume_claim.home.metadata.0.name</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">resource &quot;kubernetes_persistent_volume_claim&quot; &quot;home&quot; &#123;</span><br><span class=\"line\">  metadata &#123;</span><br><span class=\"line\">    name      = &quot;coder-$&#123;data.coder_workspace.me.owner&#125;-$&#123;data.coder_workspace.me.name&#125;-home&quot;</span><br><span class=\"line\">    namespace = &quot;coder&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  wait_until_bound = false</span><br><span class=\"line\">  spec &#123;</span><br><span class=\"line\">    access_modes = [&quot;ReadWriteOnce&quot;]</span><br><span class=\"line\">    resources &#123;</span><br><span class=\"line\">      requests = &#123;</span><br><span class=\"line\">        storage = &quot;10Gi&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">resource &quot;coder_app&quot; &quot;code-server&quot; &#123;</span><br><span class=\"line\">  agent_id     = coder_agent.main.id</span><br><span class=\"line\">  slug         = &quot;code-server&quot;</span><br><span class=\"line\">  display_name = &quot;VS Code&quot;</span><br><span class=\"line\">  url          = &quot;http://localhost:8080/?folder=/home/coder&quot;</span><br><span class=\"line\">  icon         = &quot;/icon/code.svg&quot;</span><br><span class=\"line\">  subdomain    = false</span><br><span class=\"line\">  share        = &quot;owner&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">  healthcheck &#123;</span><br><span class=\"line\">    url       = &quot;http://localhost:8080/healthz&quot;</span><br><span class=\"line\">    interval  = 5</span><br><span class=\"line\">    threshold = 6</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"监控和运维\"><a href=\"#监控和运维\" class=\"headerlink\" title=\"监控和运维\"></a>监控和运维</h2><h3 id=\"Prometheus-监控\"><a href=\"#Prometheus-监控\" class=\"headerlink\" title=\"Prometheus 监控\"></a>Prometheus 监控</h3><p>启用 Prometheus 监控：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">coder:</span></span><br><span class=\"line\">  <span class=\"attr\">env:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_PROMETHEUS_ENABLE</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_PROMETHEUS_ADDRESS</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">&quot;0.0.0.0:2112&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"日志管理\"><a href=\"#日志管理\" class=\"headerlink\" title=\"日志管理\"></a>日志管理</h3><p>查看 Coder 日志：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看控制平面日志</span></span><br><span class=\"line\">kubectl logs -f deployment/coder -n coder</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看特定工作空间日志</span></span><br><span class=\"line\">kubectl logs -f &lt;workspace-pod&gt; -n coder</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"备份策略\"><a href=\"#备份策略\" class=\"headerlink\" title=\"备份策略\"></a>备份策略</h3><h4 id=\"数据库备份\"><a href=\"#数据库备份\" class=\"headerlink\" title=\"数据库备份\"></a>数据库备份</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建数据库备份</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -it coder-db-postgresql-0 -n coder -- pg_dump -U coder -d coder &gt; coder-backup-$(<span class=\"built_in\">date</span> +%Y%m%d).sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 恢复数据库</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -i coder-db-postgresql-0 -n coder -- psql -U coder -d coder &lt; coder-backup.sql</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"配置备份\"><a href=\"#配置备份\" class=\"headerlink\" title=\"配置备份\"></a>配置备份</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 备份所有密钥和配置</span></span><br><span class=\"line\">kubectl get secrets -n coder -o yaml &gt; coder-secrets-backup.yaml</span><br><span class=\"line\">kubectl get configmaps -n coder -o yaml &gt; coder-configmaps-backup.yaml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"常见问题\"><a href=\"#常见问题\" class=\"headerlink\" title=\"常见问题\"></a>常见问题</h2><h3 id=\"1-工作空间无法连接\"><a href=\"#1-工作空间无法连接\" class=\"headerlink\" title=\"1. 工作空间无法连接\"></a>1. 工作空间无法连接</h3><p><strong>问题</strong>：工作空间状态显示为”连接中”但无法访问</p>\n<p><strong>解决方案</strong>：</p>\n<ol>\n<li>检查 <code>CODER_ACCESS_URL</code> 是否正确配置</li>\n<li>确认负载均衡器外部 IP 可访问</li>\n<li>检查网络策略和防火墙规则</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 检查服务状态</span></span><br><span class=\"line\">kubectl get svc -n coder</span><br><span class=\"line\">kubectl describe svc coder -n coder</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检查 Pod 日志</span></span><br><span class=\"line\">kubectl logs -f deployment/coder -n coder</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-TLS-证书问题\"><a href=\"#2-TLS-证书问题\" class=\"headerlink\" title=\"2. TLS 证书问题\"></a>2. TLS 证书问题</h3><p><strong>问题</strong>：HTTPS 访问出现证书错误</p>\n<p><strong>解决方案</strong>：</p>\n<ol>\n<li>确认证书文件格式正确</li>\n<li>检查证书是否包含正确的域名</li>\n<li>验证证书有效期</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 检查证书内容</span></span><br><span class=\"line\">kubectl get secret coder-tls-secret -n coder -o yaml</span><br><span class=\"line\">openssl x509 -<span class=\"keyword\">in</span> cert.pem -text -noout</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-数据库连接失败\"><a href=\"#3-数据库连接失败\" class=\"headerlink\" title=\"3. 数据库连接失败\"></a>3. 数据库连接失败</h3><p><strong>问题</strong>：Coder 无法连接到 PostgreSQL</p>\n<p><strong>解决方案</strong>：</p>\n<ol>\n<li>检查数据库连接字符串格式</li>\n<li>确认数据库服务运行正常</li>\n<li>测试网络连通性</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 测试数据库连接</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -it deployment/coder -n coder -- psql <span class=\"string\">&quot;postgres://coder:coder@coder-db-postgresql.coder.svc.cluster.local:5432/coder?sslmode=disable&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"最佳实践\"><a href=\"#最佳实践\" class=\"headerlink\" title=\"最佳实践\"></a>最佳实践</h2><h3 id=\"1-资源管理\"><a href=\"#1-资源管理\" class=\"headerlink\" title=\"1. 资源管理\"></a>1. 资源管理</h3><ul>\n<li><strong>合理配置资源限制</strong>：根据实际使用情况设置 CPU 和内存限制</li>\n<li><strong>使用节点选择器</strong>：将工作空间调度到合适的节点</li>\n<li><strong>启用水平扩缩容</strong>：根据负载自动调整副本数量</li>\n</ul>\n<h3 id=\"2-安全配置\"><a href=\"#2-安全配置\" class=\"headerlink\" title=\"2. 安全配置\"></a>2. 安全配置</h3><ul>\n<li><strong>使用 HTTPS</strong>：生产环境必须启用 TLS 加密</li>\n<li><strong>配置 OAuth</strong>：集成企业身份认证系统</li>\n<li><strong>网络隔离</strong>：使用网络策略限制不必要的网络访问</li>\n<li><strong>定期更新</strong>：及时更新 Coder 版本和依赖组件</li>\n</ul>\n<h3 id=\"3-运维管理\"><a href=\"#3-运维管理\" class=\"headerlink\" title=\"3. 运维管理\"></a>3. 运维管理</h3><ul>\n<li><strong>监控告警</strong>：配置关键指标的监控和告警</li>\n<li><strong>定期备份</strong>：建立完整的备份和恢复流程</li>\n<li><strong>日志收集</strong>：集中收集和分析日志信息</li>\n<li><strong>性能优化</strong>：定期评估和优化系统性能</li>\n</ul>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>通过本文的介绍，我们详细了解了如何在 Kubernetes 集群中部署 Coder 来构建基于 Web 的集成开发环境。Coder 为现代软件开发团队提供了一个强大而灵活的云端开发平台，具有以下优势：</p>\n<ol>\n<li><strong>标准化开发环境</strong>：消除环境差异，提高开发效率</li>\n<li><strong>安全性保障</strong>：代码和数据不离开受控环境</li>\n<li><strong>资源优化</strong>：按需分配计算资源，降低成本</li>\n<li><strong>易于管理</strong>：集中管理开发环境和权限</li>\n<li><strong>快速扩展</strong>：支持团队快速增长的需求</li>\n</ol>\n<p>在实际部署过程中，建议：</p>\n<ul>\n<li>生产环境使用托管数据库服务</li>\n<li>配置完整的监控和日志系统  </li>\n<li>建立规范的备份和恢复流程</li>\n<li>根据团队需求定制工作空间模板</li>\n</ul>\n<p>通过合理的规划和配置，Coder 可以显著提升开发团队的工作效率和协作体验。</p>\n<h2 id=\"参考资源\"><a href=\"#参考资源\" class=\"headerlink\" title=\"参考资源\"></a>参考资源</h2><ul>\n<li><a href=\"https://coder.com/docs/install/kubernetes\">Coder 官方文档</a></li>\n<li><a href=\"https://kubernetes.io/docs/\">Kubernetes 官方文档</a></li>\n<li><a href=\"https://helm.sh/docs/\">Helm 官方文档</a></li>\n<li><a href=\"https://www.postgresql.org/docs/\">PostgreSQL 官方文档</a></li>\n<li><a href=\"https://www.terraform.io/docs/\">Terraform 官方文档</a> </li>\n</ul>\n","more":"<h2 id=\"Coder-简介\"><a href=\"#Coder-简介\" class=\"headerlink\" title=\"Coder 简介\"></a>Coder 简介</h2><h3 id=\"什么是-Coder\"><a href=\"#什么是-Coder\" class=\"headerlink\" title=\"什么是 Coder\"></a>什么是 Coder</h3><p>Coder 是一个现代化的远程开发平台，具有以下特点：</p>\n<ul>\n<li><strong>云原生架构</strong>：基于 Kubernetes 容器编排</li>\n<li><strong>Web 访问</strong>：通过浏览器即可访问完整的开发环境</li>\n<li><strong>模板化管理</strong>：支持预定义的开发环境模板</li>\n<li><strong>多租户支持</strong>：支持多用户、多团队使用</li>\n<li><strong>安全隔离</strong>：每个开发环境独立运行，保证安全性</li>\n</ul>\n<h3 id=\"核心优势\"><a href=\"#核心优势\" class=\"headerlink\" title=\"核心优势\"></a>核心优势</h3><ol>\n<li><strong>统一开发环境</strong>：消除”在我机器上可以运行”的问题</li>\n<li><strong>快速上手</strong>：新员工可以快速获得标准化的开发环境</li>\n<li><strong>资源优化</strong>：按需分配计算资源，提高利用率</li>\n<li><strong>安全管控</strong>：代码和敏感数据不离开集群环境</li>\n<li><strong>跨平台访问</strong>：任何设备都可以通过浏览器访问开发环境</li>\n</ol>\n<h2 id=\"环境要求\"><a href=\"#环境要求\" class=\"headerlink\" title=\"环境要求\"></a>环境要求</h2><h3 id=\"基础要求\"><a href=\"#基础要求\" class=\"headerlink\" title=\"基础要求\"></a>基础要求</h3><ul>\n<li>Kubernetes 集群 (K8s 1.19+)</li>\n<li>Helm 3.5+ </li>\n<li>PostgreSQL 数据库</li>\n<li>负载均衡器支持</li>\n<li>TLS 证书（生产环境推荐）</li>\n</ul>\n<h3 id=\"资源规划\"><a href=\"#资源规划\" class=\"headerlink\" title=\"资源规划\"></a>资源规划</h3><ul>\n<li><strong>控制平面</strong>：2 CPU / 4GB RAM（最小配置）</li>\n<li><strong>数据库</strong>：2 CPU / 4GB RAM / 10GB 存储</li>\n<li><strong>工作空间</strong>：根据实际开发需求配置</li>\n</ul>\n<h2 id=\"安装部署步骤\"><a href=\"#安装部署步骤\" class=\"headerlink\" title=\"安装部署步骤\"></a>安装部署步骤</h2><h3 id=\"1-创建命名空间\"><a href=\"#1-创建命名空间\" class=\"headerlink\" title=\"1. 创建命名空间\"></a>1. 创建命名空间</h3><p>首先创建专用的命名空间来部署 Coder 相关组件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create namespace coder</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-部署-PostgreSQL-数据库\"><a href=\"#2-部署-PostgreSQL-数据库\" class=\"headerlink\" title=\"2. 部署 PostgreSQL 数据库\"></a>2. 部署 PostgreSQL 数据库</h3><p>Coder 需要 PostgreSQL 数据库来存储配置和状态信息。使用 Bitnami PostgreSQL Helm Chart：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加 Bitnami Helm 仓库</span></span><br><span class=\"line\">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 PostgreSQL</span></span><br><span class=\"line\">helm install coder-db ./postgresql \\</span><br><span class=\"line\">    --namespace coder \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> auth.username=coder \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> auth.password=coder \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> auth.database=coder \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> persistence.size=10Gi</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>注意</strong>：生产环境建议使用云服务商提供的托管 PostgreSQL 服务，如 AWS RDS、Google Cloud SQL 等。</p>\n</blockquote>\n<h3 id=\"3-创建数据库连接密钥\"><a href=\"#3-创建数据库连接密钥\" class=\"headerlink\" title=\"3. 创建数据库连接密钥\"></a>3. 创建数据库连接密钥</h3><p>创建包含数据库连接字符串的 Secret：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create secret generic coder-db-url -n coder \\</span><br><span class=\"line\">  --from-literal=url=<span class=\"string\">&quot;postgres://coder:coder@coder-db-postgresql.coder.svc.cluster.local:5432/coder?sslmode=disable&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>连接字符串格式说明：</p>\n<ul>\n<li><code>coder:coder</code> - 用户名和密码</li>\n<li><code>coder-db-postgresql.coder.svc.cluster.local</code> - 服务内部 DNS 名称</li>\n<li><code>5432</code> - PostgreSQL 默认端口</li>\n<li><code>coder</code> - 数据库名称</li>\n</ul>\n<h3 id=\"4-配置-OAuth-认证（可选）\"><a href=\"#4-配置-OAuth-认证（可选）\" class=\"headerlink\" title=\"4. 配置 OAuth 认证（可选）\"></a>4. 配置 OAuth 认证（可选）</h3><p>如果使用 GitLab OAuth 认证，创建相应的密钥：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create secret generic coder-gitlab-oauth-secret -n coder \\</span><br><span class=\"line\">  --from-literal=client-secret=<span class=\"string\">&quot;your-gitlab-oauth-client-secret&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-配置-TLS-证书\"><a href=\"#5-配置-TLS-证书\" class=\"headerlink\" title=\"5. 配置 TLS 证书\"></a>5. 配置 TLS 证书</h3><p>为 HTTPS 访问创建 TLS 证书密钥：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create secret tls coder-tls-secret -n coder \\</span><br><span class=\"line\">  --key=<span class=\"string\">&quot;_wildcard.coder.vxk8s.com+1-key.pem&quot;</span> \\</span><br><span class=\"line\">  --cert=<span class=\"string\">&quot;_wildcard.coder.vxk8s.com+1.pem&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>如果需要更新证书：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create secret tls coder-tls-secret -n coder \\</span><br><span class=\"line\">  --key=<span class=\"string\">&quot;_wildcard.coder.vxk8s.com+1-key.pem&quot;</span> \\</span><br><span class=\"line\">  --cert=<span class=\"string\">&quot;_wildcard.coder.vxk8s.com+1.pem&quot;</span> \\</span><br><span class=\"line\">  --dry-run=client -o yaml | kubectl apply -f -</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6-配置-CA-证书包（如需要）\"><a href=\"#6-配置-CA-证书包（如需要）\" class=\"headerlink\" title=\"6. 配置 CA 证书包（如需要）\"></a>6. 配置 CA 证书包（如需要）</h3><p>如果使用自签名证书或企业 CA，创建 CA 证书包：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create secret generic coder-ca-bundle -n coder \\</span><br><span class=\"line\">  --from-literal=ca-certs=<span class=\"string\">&quot;-----BEGIN CERTIFICATE-----</span></span><br><span class=\"line\"><span class=\"string\">MIIExjCCAy6gAwIBAgIRAPiKt6qzOqWHWGxkzg06YIYwDQYJKoZIhvcNAQELBQAw</span></span><br><span class=\"line\"><span class=\"string\"># ... 证书内容 ...</span></span><br><span class=\"line\"><span class=\"string\">-----END CERTIFICATE-----&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"7-准备-Helm-Values-文件\"><a href=\"#7-准备-Helm-Values-文件\" class=\"headerlink\" title=\"7. 准备 Helm Values 文件\"></a>7. 准备 Helm Values 文件</h3><p>创建 <code>values.yaml</code> 配置文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">coder:</span></span><br><span class=\"line\">  <span class=\"attr\">env:</span></span><br><span class=\"line\">    <span class=\"comment\"># 数据库连接配置</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_PG_CONNECTION_URL</span></span><br><span class=\"line\">      <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">        <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">coder-db-url</span></span><br><span class=\"line\">          <span class=\"attr\">key:</span> <span class=\"string\">url</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># 访问地址配置</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_ACCESS_URL</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">&quot;https://coder.vxk8s.com&quot;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># 禁用默认 GitHub OAuth（使用自定义认证）</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_OAUTH2_GITHUB_DEFAULT_PROVIDER_ENABLE</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># GitLab OAuth 配置（可选）</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_OAUTH2_GITLAB_CLIENT_ID</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">&quot;your-gitlab-client-id&quot;</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_OAUTH2_GITLAB_CLIENT_SECRET</span></span><br><span class=\"line\">      <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">        <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">coder-gitlab-oauth-secret</span></span><br><span class=\"line\">          <span class=\"attr\">key:</span> <span class=\"string\">client-secret</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_OAUTH2_GITLAB_REDIRECT_URL</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">&quot;https://coder.vxk8s.com/api/v2/users/oauth2/gitlab/callback&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># TLS 配置</span></span><br><span class=\"line\">  <span class=\"attr\">tls:</span></span><br><span class=\"line\">    <span class=\"attr\">secretNames:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">coder-tls-secret</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 服务配置</span></span><br><span class=\"line\">  <span class=\"attr\">service:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">LoadBalancer</span></span><br><span class=\"line\">    <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">    <span class=\"attr\">annotations:</span></span><br><span class=\"line\">      <span class=\"attr\">service.beta.kubernetes.io/aws-load-balancer-type:</span> <span class=\"string\">&quot;nlb&quot;</span>  <span class=\"comment\"># AWS 环境</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 资源限制</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">cpu:</span> <span class=\"string\">&quot;500m&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">memory:</span> <span class=\"string\">&quot;1Gi&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">limits:</span></span><br><span class=\"line\">      <span class=\"attr\">cpu:</span> <span class=\"string\">&quot;2000m&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">memory:</span> <span class=\"string\">&quot;4Gi&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"8-安装-Coder\"><a href=\"#8-安装-Coder\" class=\"headerlink\" title=\"8. 安装 Coder\"></a>8. 安装 Coder</h3><p>添加 Coder Helm 仓库并安装：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加 Coder Helm 仓库</span></span><br><span class=\"line\">helm repo add coder-v2 https://helm.coder.com/v2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 Coder</span></span><br><span class=\"line\">helm install coder coder-v2/coder \\</span><br><span class=\"line\">    --namespace coder \\</span><br><span class=\"line\">    --values values.yaml \\</span><br><span class=\"line\">    --version 2.22.1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"9-验证部署状态\"><a href=\"#9-验证部署状态\" class=\"headerlink\" title=\"9. 验证部署状态\"></a>9. 验证部署状态</h3><p>检查 Pod 运行状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pods -n coder</span><br></pre></td></tr></table></figure>\n\n<p>获取服务访问地址：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get svc -n coder</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"10-升级和维护\"><a href=\"#10-升级和维护\" class=\"headerlink\" title=\"10. 升级和维护\"></a>10. 升级和维护</h3><p>更新 Coder 版本：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm upgrade coder coder-v2/coder \\</span><br><span class=\"line\">    --namespace coder \\</span><br><span class=\"line\">    --values values.yaml \\</span><br><span class=\"line\">    --version 2.22.1</span><br></pre></td></tr></table></figure>\n\n<p>强制重启 Pod（如果需要）：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl delete pod &lt;pod-name&gt; -n coder --grace-period=0 --force</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置管理\"><a href=\"#配置管理\" class=\"headerlink\" title=\"配置管理\"></a>配置管理</h2><h3 id=\"环境变量配置\"><a href=\"#环境变量配置\" class=\"headerlink\" title=\"环境变量配置\"></a>环境变量配置</h3><p>Coder 支持通过环境变量进行详细配置，常用配置项：</p>\n<table>\n<thead>\n<tr>\n<th>环境变量</th>\n<th>说明</th>\n<th>示例值</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>CODER_ACCESS_URL</code></td>\n<td>外部访问地址</td>\n<td><code>https://coder.example.com</code></td>\n</tr>\n<tr>\n<td><code>CODER_PG_CONNECTION_URL</code></td>\n<td>数据库连接字符串</td>\n<td><code>postgres://user:pass@host:5432/db</code></td>\n</tr>\n<tr>\n<td><code>CODER_OAUTH2_GITHUB_CLIENT_ID</code></td>\n<td>GitHub OAuth 客户端 ID</td>\n<td><code>your-client-id</code></td>\n</tr>\n<tr>\n<td><code>CODER_PROMETHEUS_ENABLE</code></td>\n<td>启用 Prometheus 监控</td>\n<td><code>true</code></td>\n</tr>\n<tr>\n<td><code>CODER_PPROF_ENABLE</code></td>\n<td>启用性能分析</td>\n<td><code>true</code></td>\n</tr>\n</tbody></table>\n<h3 id=\"负载均衡器配置\"><a href=\"#负载均衡器配置\" class=\"headerlink\" title=\"负载均衡器配置\"></a>负载均衡器配置</h3><h4 id=\"AWS-环境\"><a href=\"#AWS-环境\" class=\"headerlink\" title=\"AWS 环境\"></a>AWS 环境</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">coder:</span></span><br><span class=\"line\">  <span class=\"attr\">service:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">LoadBalancer</span></span><br><span class=\"line\">    <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">    <span class=\"attr\">externalTrafficPolicy:</span> <span class=\"string\">Local</span></span><br><span class=\"line\">    <span class=\"attr\">annotations:</span></span><br><span class=\"line\">      <span class=\"attr\">service.beta.kubernetes.io/aws-load-balancer-type:</span> <span class=\"string\">&quot;nlb&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Azure-环境\"><a href=\"#Azure-环境\" class=\"headerlink\" title=\"Azure 环境\"></a>Azure 环境</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">coder:</span></span><br><span class=\"line\">  <span class=\"attr\">service:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">LoadBalancer</span></span><br><span class=\"line\">    <span class=\"attr\">annotations:</span></span><br><span class=\"line\">      <span class=\"attr\">service.beta.kubernetes.io/azure-load-balancer-internal:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安全配置\"><a href=\"#安全配置\" class=\"headerlink\" title=\"安全配置\"></a>安全配置</h3><h4 id=\"网络策略\"><a href=\"#网络策略\" class=\"headerlink\" title=\"网络策略\"></a>网络策略</h4><p>创建网络策略限制访问：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">NetworkPolicy</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">coder-network-policy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">coder</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podSelector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">coder</span></span><br><span class=\"line\">  <span class=\"attr\">policyTypes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">Egress</span></span><br><span class=\"line\">  <span class=\"attr\">ingress:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">from:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">namespaceSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"RBAC-配置\"><a href=\"#RBAC-配置\" class=\"headerlink\" title=\"RBAC 配置\"></a>RBAC 配置</h4><p>Coder 需要适当的 RBAC 权限来管理工作空间：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">coder</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">coder</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">coder</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;pods&quot;</span>, <span class=\"string\">&quot;services&quot;</span>, <span class=\"string\">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>, <span class=\"string\">&quot;delete&quot;</span>]</span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;apps&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;deployments&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>, <span class=\"string\">&quot;delete&quot;</span>]</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"工作空间模板\"><a href=\"#工作空间模板\" class=\"headerlink\" title=\"工作空间模板\"></a>工作空间模板</h2><h3 id=\"创建基础模板\"><a href=\"#创建基础模板\" class=\"headerlink\" title=\"创建基础模板\"></a>创建基础模板</h3><p>Coder 使用 Terraform 来定义工作空间模板。以下是一个基础的 Python 开发环境模板：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">terraform &#123;</span><br><span class=\"line\">  required_providers &#123;</span><br><span class=\"line\">    coder = &#123;</span><br><span class=\"line\">      source  = &quot;coder/coder&quot;</span><br><span class=\"line\">      version = &quot;~&gt; 0.12.0&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    kubernetes = &#123;</span><br><span class=\"line\">      source  = &quot;hashicorp/kubernetes&quot;</span><br><span class=\"line\">      version = &quot;~&gt; 2.18&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">variable &quot;use_kubeconfig&quot; &#123;</span><br><span class=\"line\">  type        = bool</span><br><span class=\"line\">  sensitive   = true</span><br><span class=\"line\">  description = &lt;&lt;-EOF</span><br><span class=\"line\">  Use host kubeconfig? (true/false)</span><br><span class=\"line\">  Set this to false if the Coder host is itself running as a Pod on the same</span><br><span class=\"line\">  Kubernetes cluster as you are deploying workspaces to.</span><br><span class=\"line\">  Set this to true if the Coder host is running outside the Kubernetes cluster</span><br><span class=\"line\">  (e.g. on a VM or your local machine).</span><br><span class=\"line\">  EOF</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">data &quot;coder_provisioner&quot; &quot;me&quot; &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">provider &quot;kubernetes&quot; &#123;</span><br><span class=\"line\">  # Authenticate via ~/.kube/config or a Coder-specific ServiceAccount, depending on admin preferences</span><br><span class=\"line\">  config_path = var.use_kubeconfig == true ? &quot;~/.kube/config&quot; : null</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">data &quot;coder_workspace&quot; &quot;me&quot; &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">resource &quot;coder_agent&quot; &quot;main&quot; &#123;</span><br><span class=\"line\">  arch                   = data.coder_provisioner.me.arch</span><br><span class=\"line\">  os                     = &quot;linux&quot;</span><br><span class=\"line\">  startup_script_timeout = 180</span><br><span class=\"line\">  startup_script         = &lt;&lt;-EOT</span><br><span class=\"line\">    set -e</span><br><span class=\"line\">    # 安装基础工具</span><br><span class=\"line\">    sudo apt-get update</span><br><span class=\"line\">    sudo apt-get install -y curl wget git vim</span><br><span class=\"line\">    </span><br><span class=\"line\">    # 安装 Python 和相关工具</span><br><span class=\"line\">    sudo apt-get install -y python3 python3-pip python3-venv</span><br><span class=\"line\">    </span><br><span class=\"line\">    # 安装 VS Code Server</span><br><span class=\"line\">    curl -fsSL https://code-server.dev/install.sh | sh</span><br><span class=\"line\">    code-server --bind-addr 0.0.0.0:8080 --auth none &amp;</span><br><span class=\"line\">  EOT</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">resource &quot;kubernetes_deployment&quot; &quot;main&quot; &#123;</span><br><span class=\"line\">  count = data.coder_workspace.me.start_count</span><br><span class=\"line\">  metadata &#123;</span><br><span class=\"line\">    name      = &quot;coder-$&#123;data.coder_workspace.me.owner&#125;-$&#123;data.coder_workspace.me.name&#125;&quot;</span><br><span class=\"line\">    namespace = &quot;coder&quot;</span><br><span class=\"line\">    labels = &#123;</span><br><span class=\"line\">      &quot;app.kubernetes.io/name&quot;     = &quot;coder-workspace&quot;</span><br><span class=\"line\">      &quot;app.kubernetes.io/instance&quot; = &quot;coder-workspace-$&#123;data.coder_workspace.me.owner&#125;-$&#123;data.coder_workspace.me.name&#125;&quot;</span><br><span class=\"line\">      &quot;app.kubernetes.io/part-of&quot;  = &quot;coder&quot;</span><br><span class=\"line\">      &quot;com.coder.resource&quot;         = &quot;true&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  spec &#123;</span><br><span class=\"line\">    replicas = 1</span><br><span class=\"line\">    selector &#123;</span><br><span class=\"line\">      match_labels = &#123;</span><br><span class=\"line\">        &quot;app.kubernetes.io/name&quot; = &quot;coder-workspace&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    template &#123;</span><br><span class=\"line\">      metadata &#123;</span><br><span class=\"line\">        labels = &#123;</span><br><span class=\"line\">          &quot;app.kubernetes.io/name&quot; = &quot;coder-workspace&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      spec &#123;</span><br><span class=\"line\">        security_context &#123;</span><br><span class=\"line\">          run_as_user = &quot;1000&quot;</span><br><span class=\"line\">          fs_group    = &quot;1000&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        container &#123;</span><br><span class=\"line\">          name              = &quot;dev&quot;</span><br><span class=\"line\">          image             = &quot;codercom/enterprise-base:ubuntu&quot;</span><br><span class=\"line\">          image_pull_policy = &quot;Always&quot;</span><br><span class=\"line\">          command           = [&quot;sh&quot;, &quot;-c&quot;, coder_agent.main.init_script]</span><br><span class=\"line\">          security_context &#123;</span><br><span class=\"line\">            run_as_user = &quot;1000&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          env &#123;</span><br><span class=\"line\">            name  = &quot;CODER_AGENT_TOKEN&quot;</span><br><span class=\"line\">            value = coder_agent.main.token</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          resources &#123;</span><br><span class=\"line\">            requests = &#123;</span><br><span class=\"line\">              &quot;cpu&quot;    = &quot;500m&quot;</span><br><span class=\"line\">              &quot;memory&quot; = &quot;1Gi&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            limits = &#123;</span><br><span class=\"line\">              &quot;cpu&quot;    = &quot;2000m&quot;</span><br><span class=\"line\">              &quot;memory&quot; = &quot;4Gi&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          volume_mount &#123;</span><br><span class=\"line\">            mount_path = &quot;/home/coder&quot;</span><br><span class=\"line\">            name       = &quot;home&quot;</span><br><span class=\"line\">            read_only  = false</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        volume &#123;</span><br><span class=\"line\">          name = &quot;home&quot;</span><br><span class=\"line\">          persistent_volume_claim &#123;</span><br><span class=\"line\">            claim_name = kubernetes_persistent_volume_claim.home.metadata.0.name</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">resource &quot;kubernetes_persistent_volume_claim&quot; &quot;home&quot; &#123;</span><br><span class=\"line\">  metadata &#123;</span><br><span class=\"line\">    name      = &quot;coder-$&#123;data.coder_workspace.me.owner&#125;-$&#123;data.coder_workspace.me.name&#125;-home&quot;</span><br><span class=\"line\">    namespace = &quot;coder&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  wait_until_bound = false</span><br><span class=\"line\">  spec &#123;</span><br><span class=\"line\">    access_modes = [&quot;ReadWriteOnce&quot;]</span><br><span class=\"line\">    resources &#123;</span><br><span class=\"line\">      requests = &#123;</span><br><span class=\"line\">        storage = &quot;10Gi&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">resource &quot;coder_app&quot; &quot;code-server&quot; &#123;</span><br><span class=\"line\">  agent_id     = coder_agent.main.id</span><br><span class=\"line\">  slug         = &quot;code-server&quot;</span><br><span class=\"line\">  display_name = &quot;VS Code&quot;</span><br><span class=\"line\">  url          = &quot;http://localhost:8080/?folder=/home/coder&quot;</span><br><span class=\"line\">  icon         = &quot;/icon/code.svg&quot;</span><br><span class=\"line\">  subdomain    = false</span><br><span class=\"line\">  share        = &quot;owner&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">  healthcheck &#123;</span><br><span class=\"line\">    url       = &quot;http://localhost:8080/healthz&quot;</span><br><span class=\"line\">    interval  = 5</span><br><span class=\"line\">    threshold = 6</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"监控和运维\"><a href=\"#监控和运维\" class=\"headerlink\" title=\"监控和运维\"></a>监控和运维</h2><h3 id=\"Prometheus-监控\"><a href=\"#Prometheus-监控\" class=\"headerlink\" title=\"Prometheus 监控\"></a>Prometheus 监控</h3><p>启用 Prometheus 监控：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">coder:</span></span><br><span class=\"line\">  <span class=\"attr\">env:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_PROMETHEUS_ENABLE</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CODER_PROMETHEUS_ADDRESS</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">&quot;0.0.0.0:2112&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"日志管理\"><a href=\"#日志管理\" class=\"headerlink\" title=\"日志管理\"></a>日志管理</h3><p>查看 Coder 日志：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看控制平面日志</span></span><br><span class=\"line\">kubectl logs -f deployment/coder -n coder</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看特定工作空间日志</span></span><br><span class=\"line\">kubectl logs -f &lt;workspace-pod&gt; -n coder</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"备份策略\"><a href=\"#备份策略\" class=\"headerlink\" title=\"备份策略\"></a>备份策略</h3><h4 id=\"数据库备份\"><a href=\"#数据库备份\" class=\"headerlink\" title=\"数据库备份\"></a>数据库备份</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建数据库备份</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -it coder-db-postgresql-0 -n coder -- pg_dump -U coder -d coder &gt; coder-backup-$(<span class=\"built_in\">date</span> +%Y%m%d).sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 恢复数据库</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -i coder-db-postgresql-0 -n coder -- psql -U coder -d coder &lt; coder-backup.sql</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"配置备份\"><a href=\"#配置备份\" class=\"headerlink\" title=\"配置备份\"></a>配置备份</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 备份所有密钥和配置</span></span><br><span class=\"line\">kubectl get secrets -n coder -o yaml &gt; coder-secrets-backup.yaml</span><br><span class=\"line\">kubectl get configmaps -n coder -o yaml &gt; coder-configmaps-backup.yaml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"常见问题\"><a href=\"#常见问题\" class=\"headerlink\" title=\"常见问题\"></a>常见问题</h2><h3 id=\"1-工作空间无法连接\"><a href=\"#1-工作空间无法连接\" class=\"headerlink\" title=\"1. 工作空间无法连接\"></a>1. 工作空间无法连接</h3><p><strong>问题</strong>：工作空间状态显示为”连接中”但无法访问</p>\n<p><strong>解决方案</strong>：</p>\n<ol>\n<li>检查 <code>CODER_ACCESS_URL</code> 是否正确配置</li>\n<li>确认负载均衡器外部 IP 可访问</li>\n<li>检查网络策略和防火墙规则</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 检查服务状态</span></span><br><span class=\"line\">kubectl get svc -n coder</span><br><span class=\"line\">kubectl describe svc coder -n coder</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检查 Pod 日志</span></span><br><span class=\"line\">kubectl logs -f deployment/coder -n coder</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-TLS-证书问题\"><a href=\"#2-TLS-证书问题\" class=\"headerlink\" title=\"2. TLS 证书问题\"></a>2. TLS 证书问题</h3><p><strong>问题</strong>：HTTPS 访问出现证书错误</p>\n<p><strong>解决方案</strong>：</p>\n<ol>\n<li>确认证书文件格式正确</li>\n<li>检查证书是否包含正确的域名</li>\n<li>验证证书有效期</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 检查证书内容</span></span><br><span class=\"line\">kubectl get secret coder-tls-secret -n coder -o yaml</span><br><span class=\"line\">openssl x509 -<span class=\"keyword\">in</span> cert.pem -text -noout</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-数据库连接失败\"><a href=\"#3-数据库连接失败\" class=\"headerlink\" title=\"3. 数据库连接失败\"></a>3. 数据库连接失败</h3><p><strong>问题</strong>：Coder 无法连接到 PostgreSQL</p>\n<p><strong>解决方案</strong>：</p>\n<ol>\n<li>检查数据库连接字符串格式</li>\n<li>确认数据库服务运行正常</li>\n<li>测试网络连通性</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 测试数据库连接</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -it deployment/coder -n coder -- psql <span class=\"string\">&quot;postgres://coder:coder@coder-db-postgresql.coder.svc.cluster.local:5432/coder?sslmode=disable&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"最佳实践\"><a href=\"#最佳实践\" class=\"headerlink\" title=\"最佳实践\"></a>最佳实践</h2><h3 id=\"1-资源管理\"><a href=\"#1-资源管理\" class=\"headerlink\" title=\"1. 资源管理\"></a>1. 资源管理</h3><ul>\n<li><strong>合理配置资源限制</strong>：根据实际使用情况设置 CPU 和内存限制</li>\n<li><strong>使用节点选择器</strong>：将工作空间调度到合适的节点</li>\n<li><strong>启用水平扩缩容</strong>：根据负载自动调整副本数量</li>\n</ul>\n<h3 id=\"2-安全配置\"><a href=\"#2-安全配置\" class=\"headerlink\" title=\"2. 安全配置\"></a>2. 安全配置</h3><ul>\n<li><strong>使用 HTTPS</strong>：生产环境必须启用 TLS 加密</li>\n<li><strong>配置 OAuth</strong>：集成企业身份认证系统</li>\n<li><strong>网络隔离</strong>：使用网络策略限制不必要的网络访问</li>\n<li><strong>定期更新</strong>：及时更新 Coder 版本和依赖组件</li>\n</ul>\n<h3 id=\"3-运维管理\"><a href=\"#3-运维管理\" class=\"headerlink\" title=\"3. 运维管理\"></a>3. 运维管理</h3><ul>\n<li><strong>监控告警</strong>：配置关键指标的监控和告警</li>\n<li><strong>定期备份</strong>：建立完整的备份和恢复流程</li>\n<li><strong>日志收集</strong>：集中收集和分析日志信息</li>\n<li><strong>性能优化</strong>：定期评估和优化系统性能</li>\n</ul>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>通过本文的介绍，我们详细了解了如何在 Kubernetes 集群中部署 Coder 来构建基于 Web 的集成开发环境。Coder 为现代软件开发团队提供了一个强大而灵活的云端开发平台，具有以下优势：</p>\n<ol>\n<li><strong>标准化开发环境</strong>：消除环境差异，提高开发效率</li>\n<li><strong>安全性保障</strong>：代码和数据不离开受控环境</li>\n<li><strong>资源优化</strong>：按需分配计算资源，降低成本</li>\n<li><strong>易于管理</strong>：集中管理开发环境和权限</li>\n<li><strong>快速扩展</strong>：支持团队快速增长的需求</li>\n</ol>\n<p>在实际部署过程中，建议：</p>\n<ul>\n<li>生产环境使用托管数据库服务</li>\n<li>配置完整的监控和日志系统  </li>\n<li>建立规范的备份和恢复流程</li>\n<li>根据团队需求定制工作空间模板</li>\n</ul>\n<p>通过合理的规划和配置，Coder 可以显著提升开发团队的工作效率和协作体验。</p>\n<h2 id=\"参考资源\"><a href=\"#参考资源\" class=\"headerlink\" title=\"参考资源\"></a>参考资源</h2><ul>\n<li><a href=\"https://coder.com/docs/install/kubernetes\">Coder 官方文档</a></li>\n<li><a href=\"https://kubernetes.io/docs/\">Kubernetes 官方文档</a></li>\n<li><a href=\"https://helm.sh/docs/\">Helm 官方文档</a></li>\n<li><a href=\"https://www.postgresql.org/docs/\">PostgreSQL 官方文档</a></li>\n<li><a href=\"https://www.terraform.io/docs/\">Terraform 官方文档</a> </li>\n</ul>","categories":[{"name":"DevOps","path":"api/categories/DevOps.json"}],"tags":[{"name":"Coder","path":"api/tags/Coder.json"},{"name":"Kubernetes","path":"api/tags/Kubernetes.json"},{"name":"DevOps","path":"api/tags/DevOps.json"},{"name":"Web IDE","path":"api/tags/Web IDE.json"},{"name":"开发环境","path":"api/tags/开发环境.json"}]}